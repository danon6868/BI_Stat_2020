---
title: "Project survival analysis"
author: "Litvinov Daniil"
date: "3/2/2021"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    number_sections: true
editor_options:
    chunk_output_type: console
---

```{r setup, include=F}
knitr::opts_chunk$set(
	echo = F,
	message = F,
	warning = F,
	include = T
)
```

```{r}
if (!requireNamespace("survival", quietly = TRUE))
  install.packages("survival")
if (!requireNamespace("survminer", quietly = TRUE))
  install.packages("survminer")
if (!requireNamespace("ggplot2", quietly = TRUE))
  install.packages("ggplot2")
if (!requireNamespace("dplyr", quietly = TRUE))
  install.packages("dplyr")
if (!requireNamespace("gridExtra", quietly = TRUE))
  install.packages("gridExtra")
if (!requireNamespace("ranger", quietly = TRUE))
  install.packages("ranger")
if (!requireNamespace("ggfortify", quietly = TRUE))
  install.packages("ggfortify")
if (!requireNamespace("coin", quietly = TRUE))
  install.packages("coin")
```

# Indtoduction

Very often in medicine or in product analytics it becomes necessary to compare two or more groups of patients who have undergone or have not undergone a certain type of "treatment". In the case of a single exposure, we sometimes can use ANOVA.

One of the possible options is the analysis of survival, when you estimate the value of the function S(t) (the situation that the subject will survive or continue to use your product longer than a certain time).

# EDA

There are 6 variables in data set and we have a short description:

- *futime*:	survival or censoring time

- *fustat*:	censoring status

- *age*:	in years

- *resid.ds*:	residual disease present (1=no,2=yes)

- *rx*:	treatment group

- *ecog.ps*:	ECOG performance status (1 is better, see reference)

```{r}
ovarian_data <- ovarian
str(ovarian_data)
ovarian_data$resid.ds <- as.factor(ovarian_data$resid.ds)
ovarian_data$rx <- as.factor(ovarian_data$rx)
ovarian_data$ecog.ps <- as.factor(ovarian_data$ecog.ps)
head(ovarian_data)
```

We see some problem related to the fact that the data is a little unbalanced, but with such a set of observations, this is not surprising.

```{r}
ecog <- ggplot(ovarian_data, aes(ecog.ps, fill = rx)) +
  geom_bar()
resid <- ggplot(ovarian_data, aes(resid.ds, fill = rx)) +
  geom_bar()
grid.arrange(ecog, resid, ncol = 2)
```


# Kaplan-Meier's curves 

This type of curves (and by the way linear models) is used in order to estimate the probability of "death" of a particular individual depending on the time t. First, we need to get the survival timeline. In other words, the time interval within which we will assess the survival rate. 

```{r}
km <- with(ovarian_data, Surv(futime, fustat))
head(km, 20)
```

Next, we make a linear model that accounts for the change in survival based on particular factor over time. 

```{r}
km_fit <- survfit(Surv(futime, fustat) ~ 1, data = ovarian_data)
summary(km_fit)
```

```{r}
autoplot(km_fit)
```

Let's take a look at how the type of treatment affects survival. 

At first glance, it seems that patients in the second treatment group are more likely to live longer.  

```{r}
km_rx_fit <- survfit(Surv(futime, fustat) ~ rx, data = ovarian_data)
autoplot(km_rx_fit)
```

Lets divide patients by age, into those who are under 57 years old and over 57 years old (based on the fact that this value divides our data roughly in half). It can be noted that the probability of living more than a year in patients aged less than 57 years is higher than in older patients. So it is quite logical.

```{r}
ovarian_data <- ovarian_data %>%  mutate(age_factor = ifelse((age < 57), "LT_57", "OV_57"),
              age_factor = factor(age_factor))
```

```{r}
km_age_fit <- survfit(Surv(futime, fustat) ~ age_factor, data = ovarian_data)
autoplot(km_age_fit)
```

We can notice that the first type of treatment has a poorer effect on the elderly, and most likely the second is better for their treatment. 

```{r}
ovarian_data_mf <- ovarian_data
ovarian_data_mf$age_treat <- as.factor(paste(ovarian_data_mf$age_factor, ovarian_data_mf$rx))
km_age_fit_rx <- survfit(Surv(futime, fustat) ~ age_treat, data=ovarian_data_mf)
autoplot(km_age_fit_rx)
```

# Comparison of groups

Another method for assessing survival is the *log-rank test*. It allows you to compare whether there is a difference in survival between groups. 

No significant differences were found between age groups.

```{r}
survdiff(Surv(futime, fustat) ~ age_factor, data = ovarian_data_mf)
logrank_test(Surv(futime, fustat) ~ age_factor, data = ovarian_data_mf)
```

In this case, we have 4 levels of the *age_treat* variable and it will be necessary to make an correction for multiple comparisons (there are 6 of them in this case). I will write a short function for this task.

```{r,echo=TRUE}
# In this case it works only for survdiff function because logrank_test does not return anything ;(
# So we can just calculate this for logrank_test by hand)

mod <- survdiff(Surv(futime, fustat) ~ age_treat, data = ovarian_data_mf)
logrank_test(Surv(futime, fustat) ~ age_treat, data = ovarian_data_mf)

n_groups <- length(levels(ovarian_data_mf$age_treat))

mult_comp_corr <- function(n_levels, model, alpha = 0.05){
  p_val <- 1 - pchisq(model$chisq, n_levels - 1)
  n_comp <- n_levels * (n_levels - 1) / 2
  alpha_adj <- alpha / n_comp
  if (p_val < alpha_adj){
    print("There are significant differences between groups")
    return(p_val)
  }
  else {
    print("There are no significant differences between groups")
    return(p_val)
  }
}

mult_comp_corr(4, mod)
```

We can assume that the interaction of the variables *factor_age* and *rx* significantly affects the life expectancy of patients. 

# Analysis of factors influencing on risk

The model shows that age is a significant predictor, which is completely logical. But Cox's model assumes that covariates do not change over time. And next we will try to check it but I think it is better to use age groups, because they will change less over time.

```{r}
cox <- coxph(Surv(futime, fustat) ~ age + rx + resid.ds + ecog.ps, data = ovarian_data_mf)
summary(cox)
```

```{r}
aa_fit <- aareg(Surv(futime, fustat) ~ age + rx + resid.ds + ecog.ps, data = ovarian_data_mf)
autoplot(aa_fit)
```

This graph shows that our covariates change slightly over time. Let's try to remove age from the model as a quantitative variable and add it as a factor in the form of age groups.

```{r}
cox <- coxph(Surv(futime, fustat) ~ age_factor + rx + resid.ds + ecog.ps, data = ovarian_data_mf)
summary(cox)
```

Let's recall what the Kaplan-Meier curve looked like for the interaction of *age_factor* and *rx* variables and try to include it in the model.

```{r}
cox <- coxph(Surv(futime, fustat) ~ age_treat + resid.ds + ecog.ps, data = ovarian_data_mf)
summary(cox)
```

```{r}
aa_fit <- aareg(Surv(futime, fustat) ~ age_treat + resid.ds + ecog.ps, data = ovarian_data_mf)
autoplot(aa_fit)
```

This model already looks much better, but does not tell us about the statistical significance of any predictors. Although *p-value* for **age_treatOV_57** pretty close to 0.05 and may be some additional test can tell us that the first type of treatment can adversely affect the life expectancy of older people.

**The Hazard Ratio** is related to the probability that an event that has not occurred at a certain point in time will occur in the next time interval. 

```{r}
fit_coxph <- coxph(Surv(futime, fustat) ~ age_treat + resid.ds + ecog.ps, data = ovarian_data_mf)
ggforest(fit_coxph, data = ovarian_data_mf)
```

# Outcomes 

As a result, there were no significant effects on risks, but there is an assumption that treatment of the first type may adversely affect the health of the elderly. 

